<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .cell {
            display: inline-block;
            width: 230px;
            height: auto;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: top;
            font-size: 16px;
            padding: 10px;
            box-sizing: border-box; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ */
        }
        .cell.empty {
            background-color: #eee;
        }
        .animal { margin-bottom: 5px; }
        .grass { margin-top: 10px; font-weight: bold;  }
        .cell-number { font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px; }
        .row { display: flex;
            flex-wrap: wrap;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è 3-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .animals-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
        }
        .animal {
            flex: 0 0 calc(50% - 10px);
            box-sizing: border-box;
            padding: 0 5px;
            font-size: 14px;
            white-space: nowrap; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
            overflow: visible; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç */
            text-overflow: clip; /* –û—Ç–∫–ª—é—á–∞–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ */
            min-width: max-content; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É */
        }
    </style>
</head>
<body>
<h1 th:text="${title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h1>
<div id="grid">
    <div class="row">
        <div class="cell empty">
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>
</div>
<script>
    /**
     * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
     * @param data –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
     */
    function renderData(data) {
        const grid = d3.select('#grid');
        grid.html('');

        const cells = data.cells || []; // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è cells

        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 10 —è—á–µ–µ–∫
        const rows = [];
        for (let i = 0; i < cells.length; i += 10) {
            rows.push(cells.slice(i, i + 10));
        }

        rows.forEach((row, rowIndex) => {
            const rowDiv = grid.append('div').attr('class', 'row');

            row.forEach((cell, cellIndex) => {
                if (!cell) return;

                const animals = cell.animals || [];
                const grassAmount = cell.grassAmount || 0;

                const cellDiv = rowDiv.append('div')
                    .attr('class', animals.length > 0 ? 'cell' : 'cell empty');

                cellDiv.append('div')
                    .attr('class', 'cell-number')
                    .text(`–Ø—á–µ–π–∫–∞ ‚Ññ${cell.index !== undefined ? cell.index + 1 : rowIndex * 10 + cellIndex + 1}`);

                if (animals.length === 0) {
                    cellDiv.append('div').text('–ü—É—Å—Ç–æ');
                } else {
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö
                    const animalsContainer = cellDiv.append('div')
                        .attr('class', 'animals-container');

                    // –î–æ–±–∞–≤–ª—è–µ–º –∂–∏–≤–æ—Ç–Ω—ã—Ö
                    animals.forEach(animal => {
                        animalsContainer.append('div')
                            .attr('class', 'animal')
                            .text(`${animal.symbol} ${animal.name}: ${animal.count}`);
                    });
                }

                cellDiv.append('div')
                    .attr('class', 'grass')
                    .text(`–¢—Ä–∞–≤–∞ üåøüçÄüå±: ${grassAmount}`);
            });
        });
    }

    /**
     * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSE.
     */
    const eventSource = new EventSource('http://localhost:8080/events');

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    eventSource.onmessage = function(event) {
        try {
            const newData = JSON.parse(event.data);
            if (!newData.cells) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
            //  renderData(newData);
            renderData(JSON.parse(event.data));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };


    //–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    eventSource.onerror = function() {
        setTimeout(() => {
            new EventSource('http://localhost:8080/events');
        }, 1000);
    };

</script>
</body>
</html>